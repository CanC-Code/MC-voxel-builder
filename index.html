<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Web Sculpt Editor</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="ui">
  <button id="addCube">Cube</button>
  <button id="addSphere">Sphere</button>
  <button id="wire">Wire</button>
  <button id="sculpt">Sculpt</button>
  <button id="destroy">Destroy</button>
  <button id="lockCam">Lock Cam</button>
</div>

<canvas id="c"></canvas>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';

const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x1e1e1e);

const camera = new THREE.PerspectiveCamera(
  60,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);
camera.position.set(3, 3, 3);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const dir = new THREE.DirectionalLight(0xffffff, 0.8);
dir.position.set(5,5,5);
scene.add(dir);

const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

let activeMesh = null;
let sculpting = false;
let wireframe = false;
let cameraLocked = false;

/* ---------- MATERIAL ---------- */
function createMaterial() {
  return new THREE.MeshStandardMaterial({
    color: 0xcccccc,
    metalness: 0.1,
    roughness: 0.8,
    wireframe: wireframe
  });
}

/* ---------- MESH CREATION ---------- */
function clearActive() {
  activeMesh = null;
}

function setActive(mesh) {
  activeMesh = mesh;
}

function addCube() {
  destroyMesh();
  const geo = new THREE.BoxGeometry(1,1,1,32,32,32);
  const mesh = new THREE.Mesh(geo, createMaterial());
  scene.add(mesh);
  setActive(mesh);
}

function addSphere() {
  destroyMesh();
  const geo = new THREE.SphereGeometry(0.75, 48, 48);
  const mesh = new THREE.Mesh(geo, createMaterial());
  scene.add(mesh);
  setActive(mesh);
}

/* ---------- DESTRUCTION (THE IMPORTANT PART) ---------- */
function destroyMesh() {
  if (!activeMesh) return;

  sculpting = false;

  scene.remove(activeMesh);

  if (activeMesh.geometry) {
    activeMesh.geometry.dispose();
  }

  if (Array.isArray(activeMesh.material)) {
    activeMesh.material.forEach(m => m.dispose());
  } else if (activeMesh.material) {
    activeMesh.material.dispose();
  }

  activeMesh = null;
}

/* ---------- SCULPTING ---------- */
function sculpt(event) {
  if (!sculpting || !activeMesh) return;

  mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);
  const hit = raycaster.intersectObject(activeMesh);

  if (hit.length === 0) return;

  const geo = activeMesh.geometry;
  const pos = geo.attributes.position;
  const p = hit[0].point;

  for (let i = 0; i < pos.count; i++) {
    const v = new THREE.Vector3().fromBufferAttribute(pos, i);
    const d = v.distanceTo(p);
    if (d < 0.25) {
      v.addScaledVector(hit[0].face.normal, 0.01);
      pos.setXYZ(i, v.x, v.y, v.z);
    }
  }

  pos.needsUpdate = true;
  geo.computeVertexNormals();
}

/* ---------- INPUT ---------- */
window.addEventListener('pointerdown', e => {
  if (!cameraLocked) sculpt(e);
});
window.addEventListener('pointermove', e => {
  if (e.buttons === 1 && !cameraLocked) sculpt(e);
});

/* ---------- UI ---------- */
document.getElementById('addCube').onclick = addCube;
document.getElementById('addSphere').onclick = addSphere;

document.getElementById('wire').onclick = () => {
  wireframe = !wireframe;
  if (activeMesh) activeMesh.material.wireframe = wireframe;
};

document.getElementById('sculpt').onclick = () => {
  sculpting = !sculpting;
};

document.getElementById('destroy').onclick = destroyMesh;

document.getElementById('lockCam').onclick = () => {
  cameraLocked = !cameraLocked;
  controls.enabled = !cameraLocked;
};

/* ---------- LOOP ---------- */
function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>